# 🔍 에러 원인 분석 가이드

## 🎯 주요 에러 2가지

---

## ❌ 에러 1: WebSocket 서버 연결 실패

```
Failed to connect to WebSocket server
WebSocket connection error
```

### 📊 원인 분석 순서

#### 1️⃣ 백엔드 서버 실행 상태 확인 (가장 흔한 원인 - 90%)

**확인 명령:**
```bash
lsof -i :3000
```

**정상 출력:**
```
COMMAND  PID   USER   FD   TYPE   DEVICE SIZE/OFF NODE NAME
node    6691 ieunho   25u  IPv6   ...      0t0  TCP *:hbci (LISTEN)
```

**아무것도 안 나오면:**
```bash
# 백엔드 서버 시작
cd /Users/ieunho/Downloads/Allsub/allsub-backend
npm run start:dev

# 정상 실행 시:
Application is running on: http://localhost:3000
```

---

#### 2️⃣ URL 설정 확인 (5%)

**앱 실행 시 콘솔 확인:**
```
═══════════════════════════════════════════════
🔍 환경 설정 진단
═══════════════════════════════════════════════
📱 Platform: ios
WebSocket URL: http://localhost:3000  ← 이게 맞아야 함
```

**iOS에서 잘못된 설정:**
```
❌ http://10.0.2.2:3000  (Android용)
❌ http://192.168.x.x:3000  (실제 디바이스용)
✅ http://localhost:3000  (iOS 시뮬레이터용)
```

**수정 위치:**
`src/config/environment.ts` - 자동 선택되므로 수정 불필요

---

#### 3️⃣ 방화벽 차단 (3%)

**확인:**
```bash
curl http://localhost:3000
```

**정상 응답:** HTML 또는 JSON 응답
**에러 응답:** Connection refused

**해결:**
```
macOS:
시스템 환경설정 
→ 보안 및 개인 정보 보호 
→ 방화벽 
→ "방화벽 옵션..." 
→ Node.js 또는 터미널 허용
```

---

#### 4️⃣ 포트 충돌 (2%)

**증상:** 백엔드 시작 시
```
Error: listen EADDRINUSE :::3000
```

**해결:**
```bash
# 1. 충돌하는 프로세스 찾기
lsof -i :3000

# 2. 프로세스 종료
kill -9 <PID>

# 3. 백엔드 재시작
npm run start:dev
```

---

## ❌ 에러 2: 자막 서비스 시작 실패

```
Failed to start subtitle service
Subtitle service start result: false
```

### 📊 원인 분석 순서

#### 1️⃣ WebSocket 연결 실패 → 에러 1 참고 (60%)

WebSocket이 연결되지 않으면 자막 서비스도 시작 불가

**확인:**
```
콘솔에 "✅ WebSocket 연결 성공!" 있는지 확인
```

**없으면:** 위의 에러 1 해결 먼저

---

#### 2️⃣ 마이크 권한 거부 (30%)

**콘솔 확인:**
```
❌ 마이크 권한 거부됨!
📱 설정 → AllSub → 마이크 권한 확인 필요
```

**해결:**
```
방법 1: 권한 팝업 다시 띄우기
1. 앱 삭제
2. 시뮬레이터/디바이스 재시작
3. 앱 재설치
4. Toggle ON → "확인" 선택

방법 2: 설정에서 직접 허용
1. iOS 설정 앱 열기
2. AllSub 앱 찾기
3. 마이크 → ON
4. 앱 재시작
```

---

#### 3️⃣ 오디오 녹음 실패 (8%)

**콘솔 확인:**
```
❌ 오디오 녹음 시작 실패
Error: ...
```

**가능한 원인:**
- 다른 앱이 마이크 사용 중
- 오디오 설정 문제
- iOS/Expo 버전 호환성

**해결:**
```
1. 다른 앱 모두 종료
2. 시뮬레이터 재시작
3. Xcode Clean Build (Command + Shift + K)
4. 앱 재빌드
```

---

#### 4️⃣ Live Activities 초기화 실패 (2%)

**증상:**
```
Live Activity 시작 실패 (iOS 16.1+ 필요)
```

**원인:**
- iOS 16.1 미만
- Widget Extension 미추가
- 네이티브 브릿지 문제

**해결:**
- iOS 16.1 이상 시뮬레이터 사용
- Widget Extension 추가 (선택사항, 자막 기능에는 영향 없음)

---

## 📝 디버깅 로그 체크리스트

### ✅ 정상 작동 시 콘솔 로그 순서:

```
1. 환경 설정
═══════════════════════════════════════════════
🔍 환경 설정 진단
═══════════════════════════════════════════════
📱 Platform: ios
WebSocket URL: http://localhost:3000

2. WebSocket 연결
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🔌 WebSocket 연결 시도
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📍 Server URL: http://localhost:3000

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
✅ WebSocket 연결 성공!
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🆔 Socket ID: abc123...

3. 마이크 권한
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🎙️  마이크 권한 요청
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
✅ 마이크 권한 허용됨!

4. 오디오 녹음
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🎤 오디오 녹음 시작
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
⏱️  청크 간격: 2000 ms
✅ 오디오 녹음 시작 성공!

5. 성공 메시지
╔═══════════════════════════════════════════════╗
║   🎉 자막 서비스 정상 작동 중!                ║
╚═══════════════════════════════════════════════╝
✅ WebSocket 연결됨
✅ 마이크 권한 허용됨
✅ 오디오 녹음 중
✅ 서버와 통신 중

6. 오디오 전송 (2초마다)
📤 오디오 청크 전송 (크기: 25 KB)
📨 오디오 청크 전송 중... ( 25 KB)

7. 자막 수신 (백엔드 처리 후)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📬 자막 수신!
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🇰🇷 원본: 안녕하세요
🇺🇸 번역: Hello
```

### ❌ 에러 발생 시 로그 예시:

#### WebSocket 연결 실패:
```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
❌ WebSocket 연결 에러
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📍 Server URL: http://localhost:3000
🔢 시도 횟수: 1 / 5
❗ Error: xhr poll error

💡 해결 방법:
   1. 백엔드 서버 실행 확인: lsof -i :3000
   2. URL 확인: http://localhost:3000
   3. 방화벽 확인
```

#### 마이크 권한 거부:
```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🎙️  마이크 권한 요청
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
❌ 마이크 권한 거부됨!
📱 설정 → AllSub → 마이크 권한 확인 필요
```

---

## 🔧 단계별 해결 플로우차트

```
자막 서비스 시작 실패?
        │
        ├─→ "WebSocket 연결 에러" 보임?
        │        │
        │        YES → 백엔드 서버 확인
        │               lsof -i :3000
        │               없으면 → npm run start:dev
        │
        ├─→ "마이크 권한 거부" 보임?
        │        │
        │        YES → 앱 삭제 후 재설치
        │               권한 팝업에서 "확인" 선택
        │
        ├─→ "오디오 녹음 실패" 보임?
        │        │
        │        YES → 시뮬레이터 재시작
        │               다른 앱 종료
        │
        └─→ 다른 에러?
                 │
                 → 전체 콘솔 로그 복사하여 확인
```

---

## 🧪 빠른 진단 명령어

### 백엔드 확인:
```bash
# 포트 3000 확인
lsof -i :3000

# 백엔드 재시작
cd /Users/ieunho/Downloads/Allsub/allsub-backend
npm run start:dev
```

### 프론트엔드 확인:
```bash
# iOS 시뮬레이터 재시작
npx expo run:ios

# 또는 Xcode에서
open ios/allsubmobile.xcworkspace
# Command + R
```

### 완전 초기화:
```bash
# 시뮬레이터 모두 삭제
xcrun simctl delete all

# iOS 프로젝트 재생성
cd allsub-mobile
rm -rf ios
npx expo prebuild --platform ios
cd ios && pod install

# 앱 재실행
npx expo run:ios
```

---

## 📞 추가 도움

### 콘솔 로그 공유 방법:

1. **Xcode 콘솔 로그 복사:**
   - Xcode 하단 콘솔 영역
   - Command + A (전체 선택)
   - Command + C (복사)

2. **주요 로그만 찾기:**
   ```
   - "WebSocket 연결" 관련 로그
   - "마이크 권한" 관련 로그
   - "오디오 녹음" 관련 로그
   - 에러 메시지 (❌로 시작)
   ```

3. **백엔드 로그도 확인:**
   ```bash
   # 백엔드 터미널에서
   - "Client connected" 있는지
   - "Starting subtitle service" 있는지
   - "Audio chunk received" 있는지
   ```

---

## 🎉 성공 확인

### 다음 로그가 모두 보이면 성공:

```
✅ 환경 설정 진단 완료
✅ WebSocket 연결 성공!
✅ 마이크 권한 허용됨!
✅ 오디오 녹음 시작 성공!
✅ Live Activity 시작됨! (iOS 16.1+)
✅ 자막 서비스 시작 완료!

╔═══════════════════════════════════════════════╗
║   🎉 자막 서비스 정상 작동 중!                ║
╚═══════════════════════════════════════════════╝
```

---

## 💡 Pro Tip

**앱 실행 시 콘솔을 주의 깊게 보세요!**

개선된 로그 시스템이 문제를 정확히 알려줍니다:
- ✅ 초록색 체크마크 = 성공
- ❌ 빨간색 X = 실패
- 💡 전구 = 해결 방법 제시

모든 ✅가 보이면 정상 작동 중입니다! 🎉

